#!/bin/bash

# ==============================================================================
# Maverick-Tor V7 (Ghost DNS Strategy)
# ==============================================================================
# Descrição: Roteamento transparente de tráfego via Tor para Arch Linux.
# Funcionalidades:
#   - Ghost DNS: Resolve conflitos com systemd-resolved usando IP fantasma.
#   - Symlink Safe: Preserva links simbólicos do /etc/resolv.conf.
#   - IPv6 Kill Switch: Previne vazamentos de identidade.
#   - Self-Healing: Restaura o estado original do sistema ao desligar.
# ==============================================================================

# --- CONFIGURAÇÕES ---
TOR_UID=$(id -u tor)
TRANS_PORT="9040"
DNS_PORT="5353"
# IP Fantasma: Um endereço inexistente na rede local para enganar o sistema
GHOST_DNS_IP="10.0.0.242" 

RESOLV_CONF="/etc/resolv.conf"
BACKUP_FILE="/tmp/resolv.conf.backup"
LINK_TARGET_FILE="/tmp/resolv.conf.link_target"

# Cores
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

function check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}[Erro] Execute como root (sudo).${NC}"
        exit 1
    fi
}

function start_tor_routing() {
    echo -e "${GREEN}[*] Iniciando Maverick-Tor (V7 - Ghost DNS)...${NC}"

    # 1. BACKUP E CONFIGURAÇÃO DE DNS "FANTASMA"
    echo "    -> Configurando DNS para IP Fantasma ($GHOST_DNS_IP)..."
    
    # Destrava preventivamente (caso tenha ficado sujo de execução anterior)
    chattr -i "$RESOLV_CONF" 2>/dev/null

    # Salva estado anterior (Link ou Arquivo)
    if [ -L "$RESOLV_CONF" ]; then
        TARGET=$(readlink "$RESOLV_CONF")
        echo "$TARGET" > "$LINK_TARGET_FILE"
    elif [ -f "$RESOLV_CONF" ]; then
        cp "$RESOLV_CONF" "$BACKUP_FILE"
    fi

    # Cria o resolv.conf apontando para o IP inexistente
    rm -f "$RESOLV_CONF"
    echo "nameserver $GHOST_DNS_IP" > "$RESOLV_CONF"
    chattr +i "$RESOLV_CONF"

    # 2. REINICIAR TOR (Garante portas abertas)
    echo "    -> Reiniciando serviço Tor..."
    systemctl restart tor
    sleep 1

    # 3. CONFIGURAÇÕES DE KERNEL
    sysctl -w net.ipv6.conf.all.disable_ipv6=1 > /dev/null
    sysctl -w net.ipv6.conf.default.disable_ipv6=1 > /dev/null
    sysctl -w net.ipv4.conf.all.route_localnet=1 > /dev/null

    # 4. FIREWALL (IPTABLES)
    iptables -F
    iptables -t nat -F

    # --- REGRAS ---

    # A. Exceção: Usuário Tor (Evita Loop Infinito)
    iptables -t nat -A OUTPUT -m owner --uid-owner $TOR_UID -j RETURN

    # B. Exceção: Loopback TCP (comunicação local de processos)
    iptables -t nat -A OUTPUT -o lo -p tcp -j RETURN

    # C. O PULO DO GATO: Captura o tráfego indo para o IP Fantasma
    # O sistema tenta enviar para 10.0.0.242, o IPTables desvia para 127.0.0.1:5353
    iptables -t nat -A OUTPUT -d $GHOST_DNS_IP -p udp --dport 53 -j DNAT --to-destination 127.0.0.1:$DNS_PORT
    iptables -t nat -A OUTPUT -d $GHOST_DNS_IP -p tcp --dport 53 -j DNAT --to-destination 127.0.0.1:$DNS_PORT
    echo "    -> DNS ($GHOST_DNS_IP) sequestrado para Tor."

    # D. Redirecionamento TCP Geral (Navegação)
    iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports $TRANS_PORT
    echo "    -> Tráfego TCP desviado para porta $TRANS_PORT."

    echo -e "${GREEN}[SUCESSO] Roteamento Ativado via Tor.${NC}"
    echo "Verifique seu IP: curl https://check.torproject.org/api/ip"
}

function stop_tor_routing() {
    echo -e "${RED}[!] Parando Maverick-Tor...${NC}"

    # Limpar Firewall
    iptables -F
    iptables -t nat -F

    # Restaurar DNS
    chattr -i "$RESOLV_CONF" 2>/dev/null
    rm -f "$RESOLV_CONF"

    if [ -f "$LINK_TARGET_FILE" ]; then
        TARGET=$(cat "$LINK_TARGET_FILE")
        ln -sf "$TARGET" "$RESOLV_CONF"
        rm "$LINK_TARGET_FILE"
        echo "    -> Link DNS original restaurado."
    elif [ -f "$BACKUP_FILE" ]; then
        cp "$BACKUP_FILE" "$RESOLV_CONF"
        rm "$BACKUP_FILE"
        echo "    -> Arquivo DNS original restaurado."
    else
        # Fallback seguro para systemd
        ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
        echo "    -> Fallback: Link padrão do systemd restaurado."
    fi

    # Acordar o resolved se necessário
    systemctl restart systemd-resolved 2>/dev/null
    
    # Restaurar IPv6
    sysctl -w net.ipv6.conf.all.disable_ipv6=0 > /dev/null
    
    echo -e "${GREEN}[OK] Internet normal restaurada.${NC}"
}

# Controle de execução
check_root
if [ "$1" = "start" ]; then
    start_tor_routing
elif [ "$1" = "stop" ]; then
    stop_tor_routing
else
    echo "Uso: sudo ./maverick-tor {start|stop}"
fi
